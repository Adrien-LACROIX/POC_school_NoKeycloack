name: SonarQube + Owaps ZAP
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    # ‚úÖ 1. Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # ‚úÖ 2. Setup Go
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    # ‚úÖ 3. Build the Go project
    - name: Build Go app
      working-directory: ./app
      run: go build -o app

    # ‚úÖ 4. Start the Go web server
    - name: Start Go Web Server
      run: |
        nohup ./app &
        sleep 10

    # ‚úÖ 5. OWASP ZAP scan with fail check
    - name: Run ZAP Scan + Fail on risk
      run: |
        docker run --network="host" \
          -v $(pwd):/zap/wrk/:rw \
          owasp/zap2docker-stable zap-baseline.py \
          -t http://localhost:8080 \
          -r zap-report.html \
          -x zap-report.xml \
          -J zap-report.json \
          -d

        echo "üîé Analyzing ZAP output..."
        HIGH=$(jq '[.site[].alerts[] | select(.riskcode=="3")] | length' zap-report.json)
        MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode=="2")] | length' zap-report.json)

        echo "‚û°Ô∏è High: $HIGH | Medium: $MEDIUM"
        if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
          echo "‚ùå Critical ZAP alerts detected"
          exit 1
        else
          echo "‚úÖ No critical ZAP alerts"
        fi

    # ‚úÖ 6. Upload the ZAP Report
    - name: Upload ZAP Report
      uses: actions/upload-artifact@v4
      with:
        name: ZAP Security Report
        path: zap-report.html
